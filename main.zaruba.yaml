includes:
  - "${ZARUBA_HOME}/scripts/core.zaruba.yaml"

tasks:


  build:
    icon: üöß
    location: ./
    extend: core.runShellScript
    config:
      start: go build


  test:
    icon: üíâ
    location: ./
    extend: core.runShellScript
    config:
      start: |
        ZARUBA_HOME=""
        mkdir -p ./coverage
        rm -f ./test_resource/alchemy/alembic.txt
        go test -v ./... --race -coverprofile=./coverage/profile.out -covermode=atomic
        go tool cover -html=./coverage/profile.out -o ./coverage/coverage.html


  serveCoverage:
    icon: ü•ó
    location: ./coverage
    extend: serveHttp
    dependencies:
      - test


  buildDocker:
    icon: üöß
    location: ./
    extend: core.runShellScript
    dependencies:
      - test
    config:
      start: |
        docker build -t stalchmst/devbox:latest -f devbox/Dockerfile .
        docker build -t stalchmst/zaruba:latest .


  runDocker:
    icon: üê≥
    location: ./
    extend: core.runShellScript
    config:
      start: |
        (docker stop zaruba || echo "container not running") && \
        (docker rm zaruba || echo "container not exist") && \
        docker run --name zaruba -p 2810:8080 -d stalchmst/zaruba:latest && \
        docker exec -it zaruba /bin/bash


  pushDocker:
    icon: üîº
    location: ./
    extend: core.runShellScript
    timeout: 1h
    dependencies:
      - buildDocker
    config:
      start: |
        docker push stalchmst/devbox:latest
        docker push stalchmst/zaruba:latest


  pushRepo:
    icon: üîº
    location: ./
    extend: core.runShellScript
    dependencies:
      - test
    config:
      start: |
        git add . -A
        git commit -m "Save changes before pushing"
        git push -u origin HEAD


  push:
    icon: üîº
    dependencies:
      - pushDocker
      - pushRepo


  initPlayground:
    icon: üé¨
    private: true
    location: ./
    extend: core.runShellScript
    config:
      start: rm -Rf playground && mkdir -p playground


  showOff:
    icon: ‚ú®
    location: ./playground
    extend: core.runShellScript
    description: Run this command with `sudo -E`
    dependencies:
      - initPlayground
      - build
    config:
      start: |
        set -e
        ZARUBA_HOME=$(realpath $(pwd)/..)
        echo "=== SORRY"
        ../zaruba sorry
        echo "=== THANKS"
        ../zaruba thanks
        echo "=== SETUP UBUNTU"
        sudo -E ../zaruba please setupUbuntu
        echo "=== INIT PROJECT"
        ../zaruba please initProject
        echo "=== ADD SUBREPOS"
        ../zaruba please addSubrepo url="https://github.com/therealvasanth/fibonacci-clock" prefix="fibo"
        ../zaruba please initSubrepos
        ../zaruba please pullSubrepos
        echo "=== ADD FIBO SERVICE"
        ../zaruba please addService location=fibo
        echo "=== ADD DOCKER SERVICE"
        ../zaruba please addDocker image=rabbitmq
        echo "=== CREATE FASTAPI SERVICE"
        ../zaruba please createService type=fastapi
        echo "=== RUN AND AUTOSTOP"
        ../zaruba please run autostop
        echo "=== SHOW FASTAPI LOG"
        ../zaruba please showLog task=fastapi
        echo "=== CLEAR LOG"
        ../zaruba please clearLog
        echo "=== EXPLAIN START"
        ../zaruba please explain start
        echo "=== DONE!!!"


  install:
    icon: üî®
    location: ./
    extend: core.runShellScript
    config:
      start: ./install.sh
