includes:
  - ./core.generator.zaruba.yaml
  - ./core.run.zaruba.yaml
  - ./core.service.zaruba.yaml
  - ./core.setup.zaruba.yaml

tasks:

  showVersion:
    icon: ðŸ”Ž
    description: |
      Show zaruba's current version.
      USAGE: zaruba please showVersion
    extend: core.runCoreScript
    config:
      start: |
        {{ $d := .Decoration -}}
        echo "{{ $d.Bold }}{{ $d.Yellow }}Current version: $(git for-each-ref --sort=-taggerdate --count=1 --format '%(tag)' refs/tags) - $(git rev-parse --verify HEAD){{ $d.Normal }}"


  update:
    icon: ðŸ”„
    description: |
      Update zaruba to the latest version.
      USAGE: zaruba please update
    extend: core.runCoreScript
    config:
      start: |
        {{ $d := .Decoration -}}
        cd ${ZARUBA_HOME}
        echo "ðŸ”½ {{ $d.Bold }}{{ $d.Yellow }}Pull zaruba{{ $d.Normal }}"
        git pull origin master
        git fetch origin --tags
        echo "ðŸš§ {{ $d.Bold }}{{ $d.Yellow }}Compile zaruba{{ $d.Normal }}"
        go build
        echo ðŸŽ‰ðŸŽ‰ðŸŽ‰
        echo "{{ $d.Bold }}{{ $d.Yellow }}Zaruba ready!!!{{ $d.Normal }}"
        echo "{{ $d.Bold }}{{ $d.Yellow }}Current version: $(git for-each-ref --sort=-taggerdate --count=1 --format '%(tag)' refs/tags) - $(git rev-parse --verify HEAD){{ $d.Normal }}"


  serveHttp:
    icon: ðŸŒ
    description: |
      Run static web server from your working directory.
      USAGE: zaruba please serveHttp [port=port]
      ARGUMENTS:
        port: HTTP Port, default to 8000
    extend: core.startService
    lconfig:
      ports: ["{{ if .Kwargs.port }}{{ .Kwargs.port }}{{ else }}8000{{ end }}"]
    start: ["python", "-m", "http.server", "{{ index .LConfig.ports 0 }}"]


  clearLog:
    icon: ðŸ”¥
    description: |
      Clear log
    extend: core.runCoreScript
    config:
      start: |
        {{ $d := .Decoration -}}
        rm -Rf log.zaruba.csv
        echo "{{ $d.Bold }}{{ $d.Yellow }}Log removed{{ $d.Normal }}"


  showLog:
    icon: ðŸ”Ž
    description: |
      Show log for all/particular tasks using regex
      USAGE:
        zaruba please showLog
        zaruba please showLog task="test.*"
      ARGUMENTS:
        task: task regex pattern, default to '.*'
    extend: core.runCoreScript
    dependencies:
    - core.setupPyUtil
    logless: true
    config:
      start: |
        if [ ! -f log.zaruba.csv ]
        then
          echo "Log is not exist" 1>&2
          exit 1
        fi
        TASK="{{ if .Kwargs.task }}{{ .Kwargs.task }}{{ else }}.*{{ end }}"
        sh "${RUN_PY}" show_log "log.zaruba.csv" "${TASK}"


  core.isValidSubrepos:
    icon: ðŸ”
    private: true
    extend: core.runCoreScript
    config:
      start: |
        {{ $d := .Decoration -}}
        {{ $names := .Kwargs.GetSubKeys "subrepo" -}}
        {{ $kwargs := .Kwargs -}}
        {{ range $index, $name := $names -}}
          PREFIX="{{ $kwargs.GetValue "subrepo" $name "prefix" }}"
          URL="{{ $kwargs.GetValue "subrepo" $name "url" }}"
          NAME="{{ $name }}"
          if [ -z "$URL" ]
          then
            echo "{{ $d.Bold }}{{ $d.Red }}Subrepo ${NAME} doesn't have url{{ $d.Normal }}" 1>&2; exit 1
          fi
          if [ -z "$PREFIX" ]
          then
            echo "{{ $d.Bold }}{{ $d.Red }}Subrepo ${NAME} doesn't have prefix{{ $d.Normal }}" 1>&2; exit 1
          fi
        {{ end }}
        echo "{{ $d.Bold }}{{ $d.Yellow }}All Subrepos are valid{{ $d.Normal }}"


  initSubrepos:
    icon: ðŸ“¦
    description: |
      Init subrepositories.
      USAGE:
        zaruba please initSubrepos
        zaruba please initSubrepos "subrepo::fibo::url=https://github.com/therealvasanth/fibonacci-clock"
      ARGUMENTS:
        subrepo::<name>::prefix: Prefix (directory name) of the subrepo
        subrepo::<name>::url:    Remote url of the subrepo
        subrepo::<name>::name:   Origin name of the subrepo
      TIPS:
        It is recommended to put `subrepo` arguments in `default.kwargs.yaml`.
        In order to do that, you can invoke `zaruba please addSubrepo <url=remote-url>`
    extend: core.runCoreScript
    dependencies:
    - core.isProject
    - core.isValidSubrepos
    - core.setupPyUtil
    config:
      start: |
        {{ $d := .Decoration -}}
        set -e
        {{ $names := .Kwargs.GetSubKeys "subrepo" -}}
        {{ $kwargs := .Kwargs -}}
        BRANCH={{ if .Kwargs.defaultBranch }}{{ .Kwargs.defaultBranch }}{{ else }}main{{ end }}
        ORIGINS=$(git remote)
        {{ range $index, $name := $names -}}
          PREFIX="{{ $kwargs.GetValue "subrepo" $name "prefix" }}"
          URL="{{ $kwargs.GetValue "subrepo" $name "url" }}"
          NAME="{{ $name }}"
          ORIGIN_EXISTS=$(sh "${RUN_PY}" is_in_array "${NAME}" ${ORIGINS})
          if [ $ORIGIN_EXISTS = 1 ]
          then
            git remote set-url "${NAME}" "${URL}"
          elif [ $ORIGIN_EXISTS = 0 ]
          then
            echo "$NAME origin is not exist"
            sh "${UTIL}/git_save.sh" "Save works before pulling from ${URL}"
            PREFIX_EXISTS=0
            if [ -d "$PREFIX" ]
            then
              PREFIX_EXISTS=1
              mv "${PREFIX}" "${PREFIX}.bak"
              sh "${UTIL}/git_save.sh" "Temporarily move ${PREFIX}"
            fi
            sh "${UTIL}/git_init_subrepo.sh" "${NAME}" "${PREFIX}" "${URL}" "${BRANCH}"
            if [ $PREFIX_EXISTS = 1 ]
            then
              rm -Rf "${PREFIX}"
              mv "${PREFIX}.bak" "${PREFIX}"
              sh "${UTIL}/git_save.sh" "Restore ${PREFIX}"
            fi
          fi
        {{ end -}}
        echo ðŸŽ‰ðŸŽ‰ðŸŽ‰
        echo "{{ $d.Bold }}{{ $d.Yellow }}Subrepos Initialized{{ $d.Normal }}"


  addSubrepo:
    icon: ðŸ¥‚
    description: |
      Add subrepository.
      USAGE:
        zaruba please addSubrepo url=https://github.com/therealvasanth/fibonacci-clock
        zaruba please addSubrepo url=https://github.com/therealvasanth/fibonacci-clock name=fibo prefix=fibo
      ARGUMENTS:
        url:    Remote url of the subrepo. (required)
        prefix: Prefix (directory name) of the subrepo. (optional)
        name:   Origin name of the subrepo. (optional)
      TIPS:
        To init subrepositories, you should perform `zaruba please initSubrepos`
    extend: core.runCoreScript
    dependencies:
    - core.isProject
    - core.setupPyUtil
    config:
      start: |
        {{ $d := .Decoration -}}
        set -e
        {{ if not .Kwargs.url }}
          echo "{{ $d.Bold }}{{ $d.Red }}Subrepo url is not defined{{ $d.Normal }}" 1>&2
          exit 1
        {{ end }}
        URL="{{ .Kwargs.url }}"
        {{ if not .Kwargs.prefix }}
          PREFIX=$(sh "${RUN_PY}" get_segment "${URL}" "/" "-1")
          PREFIX=$(sh "${RUN_PY}" get_segment "${PREFIX}" "." "0")
        {{ else }}
          PREFIX="{{ .Kwargs.prefix }}"
        {{ end }}
        {{ if not .Kwargs.name }}
          NAME="$PREFIX"
        {{ else }}
          NAME="{{ .Kwargs.name }}"
        {{ end }}
        sh "${RUN_PY}" set_project_kwarg "subrepo::${NAME}::prefix" "${PREFIX}"
        sh "${RUN_PY}" set_project_kwarg "subrepo::${NAME}::url" "${URL}"
        echo ðŸŽ‰ðŸŽ‰ðŸŽ‰
        echo "{{ $d.Bold }}{{ $d.Yellow }}Subrepo ${NAME} has been added{{ $d.Normal }}"


  pushSubrepos:
    icon: ðŸ”¼
    description: |
      Publish subrepositories.
      USAGE:
        zaruba please pushSubrepos
      ARGUMENTS:
        subrepo::<name>::prefix: Prefix (directory name) of the subrepo
        subrepo::<name>::url:    Remote url of the subrepo
    extend: core.runCoreScript
    dependencies:
    - initSubrepos
    - updateLinks
    - core.setupPyUtil
    config:
      start: |
        {{ $d := .Decoration -}}
        set -e
        {{ $names := .Kwargs.GetSubKeys "subrepo" -}}
        {{ $kwargs := .Kwargs -}}
        BRANCH={{ if .Kwargs.defaultBranch }}{{ .Kwargs.defaultBranch }}{{ else }}main{{ end }}
        ORIGINS=$(git remote)
        {{ range $index, $name := $names -}}
          PREFIX="{{ $kwargs.GetValue "subrepo" $name "prefix" }}"
          URL="{{ $kwargs.GetValue "subrepo" $name "url" }}"
          NAME="{{ $name }}"
          ORIGIN_EXISTS=$(sh "${RUN_PY}" is_in_array "${NAME}" ${ORIGINS})
          if [ $ORIGIN_EXISTS = 1 ]
          then
            sh "${UTIL}/git_save.sh" "Save works before push"
            git subtree push --prefix="${PREFIX}" "${NAME}" "${BRANCH}"
          fi
        {{ end -}}
        echo ðŸŽ‰ðŸŽ‰ðŸŽ‰
        echo "{{ $d.Bold }}{{ $d.Yellow }}Subrepos pushed{{ $d.Normal }}"


  pullSubrepos:
    icon: ðŸ”½
    description: |
      Pull subrepositories.
      USAGE:
        zaruba please pullSubrepos
      ARGUMENTS:
        subrepo::<name>::prefix: Prefix (directory name) of the subrepo
        subrepo::<name>::url:    Remote url of the subrepo
    extend: core.runCoreScript
    dependencies:
    - initSubrepos
    config:
      start: |
        {{ $d := .Decoration -}}
        set -e
        {{ $names := .Kwargs.GetSubKeys "subrepo" -}}
        {{ $kwargs := .Kwargs -}}
        ORIGINS=$(git remote)
        BRANCH={{ if .Kwargs.defaultBranch }}{{ .Kwargs.defaultBranch }}{{ else }}main{{ end }}
        {{ range $index, $name := $names -}}
          PREFIX="{{ $kwargs.GetValue "subrepo" $name "prefix" }}"
          URL="{{ $kwargs.GetValue "subrepo" $name "url" }}"
          NAME="{{ $name }}"
          ORIGIN_EXISTS=$(sh "${RUN_PY}" is_in_array "${NAME}" ${ORIGINS})
          if [ $ORIGIN_EXISTS = 1 ]
          then
            sh "${UTIL}/git_save.sh" "Save works before pull"
            git subtree pull --prefix="${PREFIX}" "${NAME}" "${BRANCH}"
          fi
        {{ end -}}
        echo ðŸŽ‰ðŸŽ‰ðŸŽ‰
        echo "{{ $d.Bold }}{{ $d.Yellow }}Subrepos pulled{{ $d.Normal }}"


  core.isProject:
    icon: ðŸ”Ž
    private: true
    extend: core.runCoreScript
    config:
      start: |
        {{ $d := .Decoration -}}
        if [ ! -e main.zaruba.yaml ]
        then
          echo "{{ $d.Bold }}{{ $d.Red }}$(pwd) is not a zaruba project{{ $d.Normal }}" 1>&2
          echo "{{ $d.Bold }}{{ $d.Red }}The task has to be executed in a zaruba project directory{{ $d.Normal }}" 1>&2
          echo "{{ $d.Bold }}{{ $d.Red }}You might want to 'initProject' first{{ $d.Normal }}" 1>&2
          exit 1
        fi
        echo "{{ $d.Bold }}{{ $d.Yellow }}Current directory is a valid zaruba project{{ $d.Normal }}"


  core.isNotProject:
    icon: ðŸ”Ž
    private: true
    extend: core.runCoreScript
    config:
      start: |
        {{ $d := .Decoration -}}
        if [ -e main.zaruba.yaml ]
        then
          echo "{{ $d.Bold }}{{ $d.Red }}$(pwd) is a zaruba project{{ $d.Normal }}" 1>&2
          echo "{{ $d.Bold }}{{ $d.Red }}The task cannot be executed in a zaruba project directory{{ $d.Normal }}" 1>&2
          exit 1
        fi
        echo "{{ $d.Bold }}{{ $d.Yellow }}Current directory is not a zaruba project{{ $d.Normal }}"


  initProject:
    icon: ðŸš§
    description: |
      Initiate empty zaruba project.
      USAGE:
        zaruba please initProject
    extend: core.runCoreScript
    dependencies:
    - core.isNotProject
    - core.setupPyUtil
    config:
      start: |
        {{ $d := .Decoration -}}
        git init
        sh "${RUN_PY}" copy_and_replace "${ZARUBA_HOME}/scripts/templates/project" .
        echo ðŸŽ‰ðŸŽ‰ðŸŽ‰
        echo "{{ $d.Bold }}{{ $d.Yellow }}Project created{{ $d.Normal }}"


  updateEnv:
    icon: ðŸ”„
    description: |
      Update environment of every task in the current project 
      USAGE:
        zaruba please updateEnv
        zaruba please updateEnv dir=.
      ARGUMENT:
        dir:  Directory name
    extend: core.runCoreScript
    dependencies:
    - core.isProject
    - core.setupPyUtil
    config:
      start: |
        {{ $d := .Decoration -}}
        DIR="{{ if .Kwargs.dir }}{{ .Kwargs.dir }}{{ else }}.{{ end }}"
        sh "${RUN_PY}" update_env "${DIR}"
        echo ðŸŽ‰ðŸŽ‰ðŸŽ‰
        echo "{{ $d.Bold }}{{ $d.Yellow }}Environment updated{{ $d.Normal }}"


  updateLinks:
    icon: ðŸ”—
    description: |
      Update "links" in your project. Very useful if you have multiple apps sharing some parts of code
      USAGE:
        zaruba please updateLinks
        zaruba please updateLinks "link::fibo/css=common-css"
        zaruba please updateLinks "link::app/css=common-css"
      ARGUMENTS
        link::<destination>:  Location of the shared code
      TIPS:
        It is recommended to put `link` arguments in `default.kwargs.yaml`.
        In order to do that, you can invoke `zaruba please addLink <from=source-location> <to=destination-location>`
    extend: core.runCoreScript
    dependencies:
    - core.isProject
    config:
      start: |
        {{ $d := .Decoration -}}
        {{ $this := . -}}
        {{ $workPath := .WorkPath }}
        {{ $destinations := .Kwargs.GetSubKeys "link" -}}
        {{ $kwargs := .Kwargs -}}
        {{ range $index, $destination := $destinations -}}
          {{ $source := $kwargs.GetValue "link" $destination -}}
          {{ $absSource := $this.GetAbsPath $workPath $source -}}
          {{ $absDestination := $this.GetAbsPath $workPath $destination -}}
          sh "${UTIL}/update_link.sh" "{{ $absSource }}" "{{ $absDestination }}"
        {{ end -}}
        echo ðŸŽ‰ðŸŽ‰ðŸŽ‰
        echo "{{ $d.Bold }}{{ $d.Yellow }}Links updated{{ $d.Normal }}"


  addLink:
    icon: ðŸ”—
    description: |
      Add link.
      USAGE:
        zaruba please addLink from="common-css" to="fibo/css"
      ARGUMENTS:
        from:   Source Location. (required)
        to:     Destination Location (required)
      TIPS:
        To update links, you should perform `zaruba please updateLinks`
    extend: core.runCoreScript
    dependencies:
    - core.isProject
    - core.setupPyUtil
    config:
      start: |
        {{ $d := .Decoration -}}
        set -e
        {{ if not .Kwargs.from }}
          echo "{{ $d.Bold }}{{ $d.Red }}'from' argument is not defined{{ $d.Normal }}" 1>&2
          exit 1
        {{ end }}
        SOURCE="{{ .Kwargs.from }}"
        {{ if not .Kwargs.to }}
          echo "{{ $d.Bold }}{{ $d.Red }}'to' argument is not defined{{ $d.Normal }}" 1>&2
          exit 1
        {{ end }}
        DESTINATION="{{ .Kwargs.to }}"
        sh "${RUN_PY}" set_project_kwarg "link::${DESTINATION)" "${SOURCE}"
        echo ðŸŽ‰ðŸŽ‰ðŸŽ‰
        echo "{{ $d.Bold }}{{ $d.Yellow }}Link ${SOURCE} -> ${DESTINATION} has been added{{ $d.Normal }}"
