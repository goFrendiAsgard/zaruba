tasks:

  core.setupPyUtil:
    icon: ğŸ
    description: |
      Setup python helper utitities.
      USAGE:
      ```yaml
      runTask:
        extend: core.runCoreScript
        dependencies: 
        - core.setupPyUtil
        config:
          start: |
            sh ${PY_UTIL} "show_log"
      ```
    private: true
    extend: core.runCoreScript
    config:
      start: |
        sh ${UTIL}/py_install.sh
  

  setupUbuntu:
    icon: ğŸ”¨
    description: |
      Setup ubuntu machine (or ubuntu WSL)
      USAGE:
        sudo -E zaruba please setupUbuntu
        sudo -E zaruba please user=<user> home=<home>
    extend: core.runCoreScript
    dependencies:
    - core.ubuntu.setup
    - core.ubuntu.setupDocker
    - core.ubuntu.setupNvm
    - core.ubuntu.setupPipenv
    config:
      start: |
        {{ $d := .Decoration -}}
        sh ${UTIL}/py_install.sh
        CURRENT_USER="{{ if .GetKwarg "user" }}{{ .GetKwarg "user" }}{{ else }}$(sh "${PY_UTIL}" get_segment "${HOME}" / -1){{ end }}"
        if [ -f "${HOME}/.local" ]
        then
          chown -R "${CURRENT_USER}" "${HOME}/.local"
        fi
        if [ -f "${HOME}/.config" ]
        then
          chown -R "${CURRENT_USER}" "${HOME}/.config"
        fi
        echo ğŸ‰ğŸ‰ğŸ‰
        echo "{{ $d.Bold }}{{ $d.Yellow }}Complete !!!{{ $d.Normal }}"
        echo "TIPS: If you are using WSL, please enable WSL2 Backend for best experience (https://docs.docker.com/docker-for-windows/wsl/)"
    

  core.ubuntu.setup:
    icon: ğŸ”¨
    extend: core.runCoreScript
    private: true
    timeout: 1h
    config:
      start: |
        {{ $d := .Decoration -}}
        {{ if .GetKwarg "home" }}HOME="{{ .GetKwarg "home" }}"{{ end }}
        sh ${UTIL}/check_setup_ubuntu.sh "${HOME}"
        echo "ğŸ“¡ {{ $d.Bold }}{{ $d.Yellow }}Update repository{{ $d.Normal }}"
        apt-get update
        apt-get upgrade -y
        echo "ğŸ”½ {{ $d.Bold }}{{ $d.Yellow }}Install packages{{ $d.Normal }}"
        apt-get install -y ncat make wget curl git python3 python3-pip tmux zsh neovim cowsay figlet lolcat
        update-alternatives --install /usr/bin/python python /usr/bin/python3 1
        update-alternatives --install /usr/bin/pip pip /usr/bin/pip3 1


  core.ubuntu.setupDocker:
    icon: ğŸ”¨
    extend: core.runCoreScript
    private: true
    timeout: 1h
    dependencies:
    - core.ubuntu.setup
    config:
      start: |
        {{ $d := .Decoration -}}
        if [ -z "$(docker -v)" ]
        then
          echo "ğŸ³ {{ $d.Bold }}{{ $d.Yellow }}Install docker{{ $d.Normal }}"
          apt-get install -y docker.io
        else
          echo "ğŸ‘ {{ $d.Bold }}{{ $d.Yellow }}Docker was already installed{{ $d.Normal }}"
        fi


  core.ubuntu.setupPipenv:
    icon: ğŸ”¨
    extend: core.runCoreScript
    private: true
    timeout: 1h
    dependencies:
    - core.ubuntu.setup
    config:
      start: |
        {{ $d := .Decoration -}}
        if [ -z "$(pipenv --version)" ]
        then
          echo "ğŸ {{ $d.Bold }}{{ $d.Yellow }}Install pipenv{{ $d.Normal }}"
          pip3 install pipenv
        else
          echo "ğŸ‘ {{ $d.Bold }}{{ $d.Yellow }}Pipenv was already installed{{ $d.Normal }}"
        fi


  core.ubuntu.setupNvm:
    icon: ğŸ”¨
    extend: core.runCoreScript
    private: true
    timeout: 1h
    dependencies:
    - core.ubuntu.setup
    - core.ubuntu.setupPipenv
    config:
      start: |
        {{ $d := .Decoration -}}
        {{ if .GetKwarg "home" }}HOME="{{ .GetKwarg "home" }}"{{ end }}
        sh ${UTIL}/py_install.sh
        CURRENT_USER="{{ if .GetKwarg "user" }}{{ .GetKwarg "user" }}{{ else }}$(sh "${PY_UTIL}" get_segment "${HOME}" / -1){{ end }}"
        if [ -d "${HOME}/.nvm" ]
        then
          echo "ğŸ‘ {{ $d.Bold }}{{ $d.Yellow }}NVM was already installed{{ $d.Normal }}"
        else
          echo "ğŸ¸ {{ $d.Bold }}{{ $d.Yellow }}Install NVM{{ $d.Normal }}"
          curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.37.0/install.sh | bash
          NVM_DIR="$HOME/.nvm"
          \. "$NVM_DIR/nvm.sh"
          nvm install node
          chown -R "${CURRENT_USER}" "$NVM_DIR"
          if [ -f ${HOME}/.zshrc ]
          then
            echo '' >> "${HOME}/.zshrc"
            echo 'export NVM_DIR="$HOME/.nvm"' >> "${HOME}/.zshrc"
            echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm' >> "${HOME}/.zshrc"
            echo '[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion' >> "${HOME}/.zshrc"
          fi
        fi
        if [ -z "$(tsc -v)" ]
        then
          echo "ğŸ¸ {{ $d.Bold }}{{ $d.Yellow }}Install typescript{{ $d.Normal }}"
          npm install -g typescript
        else
          echo "ğŸ‘ {{ $d.Bold }}{{ $d.Yellow }}Typescript was already installed{{ $d.Normal }}"
        fi
        if [ -z "$(node-gyp -v)" ]
        then
          echo "ğŸ¸ {{ $d.Bold }}{{ $d.Yellow }}Install node-gyp{{ $d.Normal }}"
          npm install -g node-gyp
        else
          echo "ğŸ‘ {{ $d.Bold }}{{ $d.Yellow }}Node-gyp was already installed{{ $d.Normal }}"
        fi
